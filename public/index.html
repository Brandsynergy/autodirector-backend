<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>AutoDirector</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b0c10;
      --panel:#14151a;
      --panel2:#181a20;
      --border:#252731;
      --text:#e6e7eb;
      --muted:#a6a8ad;
      --accent:#8b5cf6;
      --accent-2:#7c3aed;
      --success:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;
    }
    *{ box-sizing:border-box }
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    a{ color:var(--accent); text-decoration:none }
    a:hover{ text-decoration:underline }
    .wrap{ max-width:1200px; margin:0 auto; padding:28px 20px 40px }
    .row{ display:flex; align-items:center; justify-content:space-between; gap:16px }
    .brand{ display:flex; align-items:center; gap:12px }
    .logo{ width:40px; height:40px; border-radius:12px; background:var(--accent); display:grid; place-items:center; color:#fff; font-weight:800; letter-spacing:.5px }
    .kicker{ color:var(--muted); font-size:12px }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      background: rgba(139,92,246,.12); color:var(--accent);
      border:1px solid #8b5cf633; padding:6px 10px; border-radius:999px; font-weight:700; font-size:12px; letter-spacing:.25px
    }
    .badge.success{ background: rgba(34,197,94,.15); color:var(--success); border-color:#22c55e33 }
    .panel{
      background:var(--panel); border:1px solid var(--border); border-radius:18px; padding:18px;
    }
    h3{ margin:0 0 10px 0; font-size:16px; letter-spacing:.2px }
    .topbar{ margin-bottom:10px; display:flex; align-items:center; justify-content:space-between }
    .btn{
      cursor:pointer; border-radius:12px; padding:10px 14px; font-weight:700; font-size:14px;
      border:1px solid transparent; transition:background .15s, transform .05s; display:inline-flex; align-items:center; gap:8px
    }
    .btn:active{ transform:scale(.99) }
    .btn.primary{ background:var(--accent); color:#fff; border-color:var(--accent) }
    .btn.primary:hover{ background:var(--accent-2) }
    .btn.subtle{ background:var(--panel2); color:var(--text); border:1px solid var(--border) }
    .btn.ghost{ background:transparent; color:var(--text); border:1px solid var(--border) }
    textarea{
      width:100%; min-height:100px; resize:vertical; outline:none;
      background:var(--panel); color:var(--text); border:1px solid var(--border);
      border-radius:14px; padding:14px 16px; font-size:15px;
    }
    textarea:focus{ border-color:var(--accent); box-shadow:0 0 0 3px #8b5cf622 }
    pre{
      margin:0; white-space:pre-wrap; background:var(--panel); color:var(--text);
      border:1px solid var(--border); border-radius:14px; padding:12px; min-height:120px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:13px;
    }
    .grid{ display:grid; grid-template-columns:1fr; gap:18px }
    @media (min-width:1100px){ .grid{ grid-template-columns:1fr 1fr } }
    .chips{ display:flex; flex-wrap:wrap; gap:8px; margin-top:12px }
    .chip{
      cursor:pointer; background:var(--panel2); color:var(--text);
      border:1px solid var(--border); border-radius:999px; padding:8px 12px; font-size:12px;
    }
    .shots{ display:grid; grid-template-columns:repeat(auto-fill, minmax(180px,1fr)); gap:10px; margin-top:8px }
    .thumb{ border:1px solid var(--border); border-radius:12px; overflow:hidden; background:var(--panel2) }
    .thumb img{ display:block; width:100%; height:auto }
    .muted{ color:var(--muted) }
    .hint{ color:var(--muted); font-size:12px; margin-top:4px }
    .flex{ display:flex; gap:12px; align-items:center; flex-wrap:wrap }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Header -->
    <div class="row" style="padding-bottom:8px">
      <div class="brand">
        <div class="logo">AD</div>
        <div>
          <div style="font-size:24px; font-weight:800; letter-spacing:.2px">AutoDirector</div>
          <div class="kicker">Natural-language → browser automation. GitHub → Render (no Lovable needed).</div>
        </div>
      </div>
      <div class="flex">
        <span id="creditsBadge" class="badge">Credits: …</span>
        <span class="badge success">Backend: <span id="hostLabel"></span></span>
      </div>
    </div>

    <!-- Main -->
    <div class="grid">
      <!-- Left column -->
      <div class="grid" style="gap:18px">
        <div class="panel">
          <div class="topbar">
            <h3>Describe what to automate</h3>
            <span id="statusBadge" class="badge">Idle</span>
          </div>
          <textarea id="prompt"></textarea>
          <div class="flex" style="margin-top:12px">
            <button id="planBtn" class="btn primary">Plan Automation</button>
            <button id="runBtn" class="btn subtle">Run</button>
          </div>
          <div class="chips" id="chips"></div>
        </div>

        <div class="panel">
          <div class="topbar">
            <h3>Planned Flow</h3>
            <button id="copyBtn" class="btn ghost">Copy JSON</button>
          </div>
          <pre id="flowBox">Click “Plan Automation”.</pre>
        </div>
      </div>

      <!-- Right column -->
      <div class="grid" style="gap:18px">
        <div class="panel">
          <h3>Run Console</h3>
          <pre id="consoleBox">—</pre>
          <div id="shotsWrap" style="display:none">
            <div class="hint" style="margin-top:10px; font-weight:700; letter-spacing:.3px">Screenshots</div>
            <div id="shots" class="shots"></div>
          </div>
          <div id="videoWrap" style="display:none; margin-top:12px">
            <a id="videoLink" target="_blank">Open recorded video</a>
          </div>
        </div>

        <div class="panel">
          <h3>Tips</h3>
          <ul class="muted" style="margin:0; padding-left:18px">
            <li>Say <strong>“screenshot … and email it to …”</strong> for one-step capture + email.</li>
            <li>Use <strong>“Forward my last 3 emails to …”</strong> to forward previews from Gmail.</li>
            <li>Try <strong>“Save https://… as PDF and email it to …”</strong> for quick PDF exports.</li>
            <li>Use precise URLs (e.g., <em>https://www.cnn.com</em>) for best results.</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  const API = ""; // same origin (served by Express). If hosting UI elsewhere, put full base URL here.
  const $ = sel => document.querySelector(sel);

  // anon id
  let anonId = localStorage.getItem("autodirector_anon_id");
  if (!anonId){ anonId = Math.random().toString(36).slice(2) + Date.now().toString(36); localStorage.setItem("autodirector_anon_id", anonId); }

  // UI elements
  const hostLabel = $("#hostLabel");
  const creditsBadge = $("#creditsBadge");
  const statusBadge = $("#statusBadge");
  const prompt = $("#prompt");
  const planBtn = $("#planBtn");
  const runBtn = $("#runBtn");
  const flowBox = $("#flowBox");
  const copyBtn = $("#copyBtn");
  const consoleBox = $("#consoleBox");
  const shotsWrap = $("#shotsWrap");
  const shotsEl = $("#shots");
  const videoWrap = $("#videoWrap");
  const videoLink = $("#videoLink");
  const chips = $("#chips");

  hostLabel.textContent = location.host;

  // sample prompts
  const samples = [
    "Screenshot https://www.cnn.com and email it to support@mivado.co",
    "Save https://example.com as PDF and email it to support@mivado.co",
    "Email me top Google News on Formula 1 to support@mivado.co",
    "Forward my last 3 emails to support@mivado.co"
  ];
  samples.forEach(t=>{
    const b = document.createElement("button");
    b.className = "chip";
    b.textContent = t;
    b.onclick = ()=>{ prompt.value = t; };
    chips.appendChild(b);
  });

  // defaults
  prompt.value = 'Open https://example.com and take a screenshot, then email it to support@mivado.co.';

  // state
  let flow = null;
  let runId = null;
  let poll = null;

  function setStatus(txt, tone="neutral"){
    statusBadge.textContent = txt;
    statusBadge.className = "badge";
    if (tone==="success") statusBadge.classList.add("success");
    if (tone==="danger")  statusBadge.classList.add("danger");
  }

  function setConsole(lines){
    consoleBox.textContent = lines && lines.length ? lines.join("\\n") : "—";
  }

  function setShots(list){
    if (!list || !list.length){ shotsWrap.style.display = "none"; shotsEl.innerHTML=""; return; }
    shotsWrap.style.display = "";
    shotsEl.innerHTML = "";
    list.forEach(s=>{
      const a = document.createElement("a");
      a.href = s.url; a.target = "_blank"; a.className = "thumb";
      const img = document.createElement("img");
      img.src = s.url;
      a.appendChild(img);
      shotsEl.appendChild(a);
    });
  }

  async function fetchJSON(url, opts={}){
    const r = await fetch(url, { ...opts, headers: { ...(opts.headers||{}), "x-anon-id": anonId, "content-type": "application/json" } });
    return await r.json();
  }

  async function refreshUser(){
    try{
      const d = await fetchJSON(API + "/api/user");
      creditsBadge.textContent = "Credits: " + (d.credits ?? "—");
    }catch{}
  }

  async function plan(){
    setStatus("planning…");
    flow = null; flowBox.textContent = "Planning…"; setConsole([]);
    setShots(null); videoWrap.style.display = "none";
    try{
      const d = await fetchJSON(API + "/api/plan", { method:"POST", body: JSON.stringify({ prompt: prompt.value }) });
      flow = d.flow || null;
      flowBox.textContent = flow ? JSON.stringify(flow, null, 2) : "No plan. Try rephrasing your prompt.";
      setStatus("planned");
    }catch(e){
      setStatus("plan error","danger");
      flowBox.textContent = "Planning failed. Please try again.";
    }
  }

  async function run(){
    if (!flow){ await plan(); if (!flow) return; }
    setStatus("running");
    consoleBox.textContent = "—"; setShots(null); videoWrap.style.display = "none";
    try{
      const d = await fetchJSON(API + "/api/run", { method:"POST", body: JSON.stringify({ flow }) });
      runId = d.id;
      if (!runId){ setStatus("run error", "danger"); return; }
      // poll
      poll && clearInterval(poll);
      poll = setInterval(async ()=>{
        try{
          const s = await fetchJSON(API + "/api/run/" + runId);
          setConsole(s.logs||[]);
          setShots(s.shots || []);
          if (s.videoUrl){
            videoWrap.style.display = "";
            videoLink.href = s.videoUrl;
            videoLink.textContent = "Open recorded video";
          }
          if (s.status === "done"){
            setStatus("done","success"); clearInterval(poll); refreshUser();
          }
          if (s.status === "error"){
            setStatus("error","danger"); clearInterval(poll); refreshUser();
          }
        }catch(e){}
      }, 1200);
    }catch(e){
      setStatus("run error","danger");
    }
  }

  // events
  planBtn.onclick = plan;
  runBtn.onclick  = run;
  copyBtn.onclick = ()=>{
    if (!flow) return;
    navigator.clipboard.writeText(JSON.stringify(flow, null, 2));
    copyBtn.textContent = "Copied";
    setTimeout(()=> copyBtn.textContent = "Copy JSON", 900);
  };

  // boot
  refreshUser();
})();
</script>
</body>
</html>
